{% extends "templates_supporting/sidebar_asset_management.html" %}

{% block script %}
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/chart.js@3.2.0/dist/chart.min.js"></script>

    <script>
        {#var ctx = document.getElementById('myChart').getContext('2d');#}
        var ctx1 = document.getElementById('pieVulnerabilityPerAssetType').getContext('2d');
        var ctx2 = document.getElementById('barTopVulnerabilities').getContext('2d');
        var ctx3 = document.getElementById('lineVulnerabilityPerMonth').getContext('2d');


        const dataVulnerabilityPerAssetType = {
            labels:
                {{ asset_types_list | safe}},

            datasets: [
                {
                    label: 'Dataset 1',
                    data: {{ asset_types_vulnerability_occurrence | safe }},
                    color: '#ffffff',
                    backgroundColor: ['#003f5c',
                        '#2f4b7c',
                        '#665191',
                        '#a05195',
                        '#d45087',
                        '#f95d6a',
                        '#ff7c43',
                        '#ffa600',
                        '#e6e600']
                }
            ]
        };

        const dataBarTopVulnerabilities = {
            labels:
                {{ vulnerability_cve_id_list | safe }},
                {#[#}
                {#    'Vulnerability #1',#}
                {#    'Vulnerability #2',#}
                {#    'Vulnerability #3',#}
                {#    'Vulnerability #4',#}
                {#    'Vulnerability #5',#}
                {#    'Vulnerability #6',#}
                {#    'Vulnerability #7',#}
                {#    'Vulnerability #8',#}
                {#    'Vulnerability #9',#}
                {#    'Vulnerability #10',#}
                {#],#}

            datasets: [
                {
                    label: 'Top Threats by Liklihood',
                    data: {{ vulnerability_cve_id_occurrence | safe }},
                    backgroundColor:
                        ['#e5029d',
                        '#345cba',
                        '#67e6ef',
                        '#fc7671',
                        '#c6af00',
                        '#dd5646',
                        '#07915e',
                        '#5d55cc',
                        '#3fc1a7',
                        '#d8261a',
                        '#55fc87']
                }
            ]
        };

        const dataLineVulnerabilityPerMonth = {
            labels:
                [
                    'Jan',
                    'Feb',
                    'Mar',
                    'Apr',
                    'May',
                    'Jun',
                    'Jul',
                    'Aug',
                    'Sept',
                    'Oct',
                    'Nov',
                    'Dec'
                ],

            datasets: [
                {
                    label: 'System Vulnerabilities',
                    data: [1, 2, 4, 3, 6, 5, 1, 6, 9, 3, 2, 1],
                    borderColor: "#e6e600",
                    backgroundColor:
                        '#e6e600'

                    {#    '#e5029d',#}
                    {#    '#345cba',#}
                    {#    '#67e6ef',#}
                    {#    '#fc7671',#}
                    {#    '#c6af00',#}
                    {#    '#dd5646',#}
                    {#    '#07915e',#}
                    {#    '#5d55cc',#}
                    {#    '#3fc1a7',#}
                    {#    '#d8261a',#}
                    {#    '#55fc87'#}
                    {#]#}
                }
            ]
        };


        var pieVulnerabilityPerAssetType = new Chart(ctx1, {
            type: 'pie',
            data: dataVulnerabilityPerAssetType,
            options: {
                responsive: true,
                color: '#ffffff',
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Vulnerabilities present in each asset type',
                        color: '#ffffff'
                    },

                }
            },
        })

        var pieOwned = new Chart(ctx2, {
            type: 'bar',
            data: dataBarTopVulnerabilities,
            options: {
                responsive: true,
                indexAxis: 'y',
                color: '#ffffff',
                scales: {
                    x: {
                        grid: {
                            display: 'true',
                            color: "#ffffff"
                        },
                        ticks: {
                            color: '#ffffff'
                        }
                    },
                    y: {
                        grid: {
                            display: 'true',
                            color: "#ffffff"

                        },
                        ticks: {
                            color: '#ffffff'
                        }
                    },

                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Top Vulnerabilities by Occurrence',
                        color: '#ffffff'
                    }
                }
            },
        })

        var lineVulnerabilityPerMonth = new Chart(ctx3, {
            type: 'line',
            data: dataLineVulnerabilityPerMonth,
            options: {
                responsive: true,
                color: '#ffffff',
                {#borderColor: '#ffffff',#}
                {#backgroundColor: '#ffffff',#}
                scales: {
                    x: {
                        grid: {
                            color: '#ffffff'
                        },
                        ticks: {
                            color: '#ffffff'
                        }
                    },
                    y: {
                        grid: {
                            color: '#ffffff'
                        },
                        ticks: {
                            color: '#ffffff'
                        }
                    },

                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'High likelihood threats per number of assets threatened',
                        color: '#ffffff'
                    }
                }
            },
        })

        function rowStyle(row, index) {
            console.log(row)
            console.log(row.has_static_ip)
            if (typeof row.has_static_ip !== "undefined") {
                if (row.has_static_ip === true) {
                    console.log("Is false")
                    return {
                        css: {
                            color: 'blue'
                        }
                    }
                } else {
                    console.log("Is true")
                    return {
                        css: {
                            color: 'red'
                        }
                    }
                }
            } else {
                console.log("Is undefined")
                return {
                    css: {
                        color: 'red'
                    }
                }
            }

        }

        var $table = $('#table')

        function operateFormatter(value, row, index) {
            return [
                {#'<a class="edit" href="javascript:void(0)" title="Edit">',#}
                {#'<i class="fa fa-edit"></i>',#}
                {#'</a>  ',#}
                '<a type="button" class="btn btn-primary fa fa-edit" href="/repo/assets/">\n' +
                '<span class= "custom-font">Asset Verification</span>' +
                '</a>'
            ].join('')
        }

        $(function () {
            var data = {{ repo_vulnerabilities | safe }};
            console.log(data)
            $table.bootstrapTable({data: data});
        })
    </script>

{% endblock %}


{% block content %}
    <h1>Vulnerability Dashboard</h1>
        <hr/>
        <a class="btn btn-primary" href="/repo/vulnerabilities/"> Detailed Vulnerabilities View </a>
    <hr/>
    <div class="row dashboard-row">
        <div class="col-5 custom-select-column">
            <canvas id="pieVulnerabilityPerAssetType" width="400" height="400"></canvas>
        </div>
        <div class="col-5 custom-select-column">
            <canvas id="barTopVulnerabilities" width="400" height="400"></canvas>
        </div>
    </div>
    <hr/>
    <h5>Top Assets per Vulnerabilities</h5>
        <br/>
        <div id="toolbar">

        </div>
        <table
                id="table"
                data-toolbar="#toolbar"
                data-search="true"
                data-search-on-enter-key="true"
                data-show-search-button="true"
                data-show-refresh="true"
                data-show-toggle="true"
                data-show-fullscreen="true"
                data-show-columns="true"
                data-show-columns-toggle-all="true"
                data-loading-template="loadingTemplate"
                data-pagination="true"
                data-page-list="[10, 25, 50, 100, all]"
                show-button-icons="true"
                data-row-style="rowStyle"
        >
            <thead>
            <tr>
            <th data-field="id" data-sortable="true">ID</th>
            <th data-field="name" data-sortable="true">Name</th>
            <th data-field="vulnerabilities" data-sortable="true">Vulnerabilities</th>
            <th data-field="description" data-sortable="true">Description</th>
            <th data-field="owner" data-sortable="true">Owner</th>
            <th data-field="location" data-sortable="true">Location</th>
            <th data-field="Verified" data-sortable="true">Verified</th>
            <th data-field="verified_by" data-sortable="true">Verified by</th>
            <th data-field="mac_address" data-sortable="true">Mac_address</th>
            <th data-field="has_static_ip" data-sortable="true">Has static IP</th>
            <th data-field="ip">IP</th>
            <th data-field="net_group_fk" data-sortable="true">Name</th>
            <th data-field="value" data-sortable="true">Value</th>
            <th data-field="loss_of_revenue" data-sortable="true">Loss of Revenue</th>
            <th data-field="additional_expenses" data-sortable="true">Additional Expenses</th>
            <th data-field="regulatory_legal" data-sortable="true">Regulatory Legal</th>
            <th data-field="customer_service" data-sortable="true">Customer_service</th>
            <th data-field="goodwill" data-sortable="true">Goodwill</th>
            <th data-field="last_touch_date" data-sortable="true">Last Touch Date</th>
            <th data-field="type_fk" data-sortable="true">Type</th>
            <th data-field="operate" data-formatter="operateFormatter" data-events="operateEvents">Item Price</th>
            </tr>
            </thead>
        </table>
    <hr/>
    <div class="row dashboard-row">
        <div class="col-8 custom-select-column">
            <canvas id="lineVulnerabilityPerMonth" width="400" height="400"></canvas>
        </div>
    </div>


{% endblock %}
